<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>空间数据结构 | 星光咖啡馆</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="空间数据结构在游戏程序中，利用空间数据结构加速计算往往是非常重要的优化思想，空间数据结构可以应用于场景管理、渲染、物理、游戏逻辑等方面link19.1 空间数据结构 - Justin的文章 - 知乎 四叉树&#x2F;八叉树四叉树索引的基本思想是将地理空间递归划分为不同层次的树结构。它将已知范围的空间等分成四个相等的子空间，如此递归下去，直至树的层次达到一定深度或者满足某种要求后停止分割 松散四叉">
<meta property="og:type" content="article">
<meta property="og:title" content="空间数据结构">
<meta property="og:url" content="http://example.com/2023/01/02/DataStructure/%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/index.html">
<meta property="og:site_name" content="星光咖啡馆">
<meta property="og:description" content="空间数据结构在游戏程序中，利用空间数据结构加速计算往往是非常重要的优化思想，空间数据结构可以应用于场景管理、渲染、物理、游戏逻辑等方面link19.1 空间数据结构 - Justin的文章 - 知乎 四叉树&#x2F;八叉树四叉树索引的基本思想是将地理空间递归划分为不同层次的树结构。它将已知范围的空间等分成四个相等的子空间，如此递归下去，直至树的层次达到一定深度或者满足某种要求后停止分割 松散四叉">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic4.zhimg.com/v2-c5c1bd8dc6ea2f6b0847949628f397ef_b.jpg">
<meta property="og:image" content="https://pic3.zhimg.com/v2-6ac7face42d5517f8e2519299d2b5eae_b.jpg">
<meta property="og:image" content="http://example.com/showImg/show104.png">
<meta property="og:image" content="http://example.com/showImg/show105.jpg">
<meta property="og:image" content="http://example.com/showImg/BVH/show1.gif">
<meta property="og:image" content="http://example.com/showImg/show109.png">
<meta property="og:image" content="http://example.com/showImg/show110.png">
<meta property="og:image" content="http://example.com/showImg/show106.png">
<meta property="og:image" content="http://example.com/showImg/show107.png">
<meta property="og:image" content="http://example.com/showImg/show108.png">
<meta property="og:image" content="http://example.com/showImg/BVH/show1.jpg">
<meta property="og:image" content="https://pic2.zhimg.com/v2-2dae685b5443e6978ae112484d10eeb5_b.jpg">
<meta property="og:image" content="https://docs.unrealengine.com/4.27/Images/InteractiveExperiences/Physics/Collision/HowTo/kdop_sizes.webp">
<meta property="article:published_time" content="2023-01-02T11:06:29.000Z">
<meta property="article:modified_time" content="2023-12-31T10:28:17.896Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="DataStructure">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic4.zhimg.com/v2-c5c1bd8dc6ea2f6b0847949628f397ef_b.jpg">
  
    <link rel="alternate" href="/atom.xml" title="星光咖啡馆" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/img/blog_top.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="  ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>星光咖啡馆 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M198-120q-25.846 0-44.23-18.384-18.384-18.385-18.384-44.23 0-25.846 18.384-44.23 18.384-18.385 44.23-18.385 25.846 0 44.23 18.385 18.384 18.384 18.384 44.23 0 25.845-18.384 44.23Q223.846-120 198-120Zm538.385 0q-18.846 0-32.923-13.769-14.076-13.769-15.922-33.23-8.692-100.616-51.077-188.654-42.385-88.039-109.885-155.539-67.5-67.501-155.539-109.885Q283-663.462 182.385-672.154q-19.461-1.846-33.23-16.23-13.769-14.385-13.769-33.846t14.076-32.922q14.077-13.461 32.923-12.23 120.076 8.692 226.038 58.768 105.961 50.077 185.73 129.846 79.769 79.769 129.846 185.731 50.077 105.961 58.769 226.038 1.231 18.846-12.538 32.922Q756.461-120 736.385-120Zm-252 0q-18.231 0-32.423-13.461t-18.653-33.538Q418.155-264.23 348.886-333.5q-69.27-69.27-166.501-84.423-20.077-4.462-33.538-18.961-13.461-14.5-13.461-33.346 0-19.076 13.884-33.23 13.884-14.153 33.115-10.922 136.769 15.384 234.384 112.999 97.615 97.615 112.999 234.384 3.231 19.23-10.538 33.115Q505.461-120 484.385-120Z"/></svg>
      </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/img/head.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">泥头车 </div>
      <div class="dot"></div>
      <div class="subtitle">若无闲事挂心头，便是人间好时节 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com/yHjoXasQ7ntcYs8" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://steamcommunity.com/id/ruanchuan/" title="Steam"><i class="fa-brands fa-steam"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/ruancuan" title="Github"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/C/">
                C#
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%8D%9A%E5%AE%A2/">
                博客
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">
                嵌入式
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/%E6%B8%B2%E6%9F%93/">
                渲染
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%AE%9E%E6%97%B6%E6%B8%B2%E6%9F%934/">
                实时渲染4
                <div class="category-count">10</div>
            </a>
        
            <a class="category-link" href="/categories/%E6%B8%B8%E6%88%8F%E8%AE%B0%E5%BD%95/">
                游戏记录
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">
                开发工具
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">
                工作记录
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/categories/%E6%B8%B8%E6%88%8F%E6%A1%86%E6%9E%B6/">
                游戏框架
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/%E7%8E%A9/">
                玩
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%BC%95%E6%93%8E/">
                引擎
                <div class="category-count">5</div>
            </a>
        
            <a class="category-link" href="/categories/GamePlay/">
                GamePlay
                <div class="category-count">7</div>
            </a>
        
            <a class="category-link" href="/categories/%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">
                空间数据结构
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/GameDev/">
                GameDev
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/categories/%E8%8D%89%E5%9C%B0%E7%BC%96%E8%BE%91%E5%99%A8/">
                草地编辑器
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/categories/Unity/">
                Unity
                <div class="category-count">16</div>
            </a>
        
            <a class="category-link" href="/categories/RenderingAcceleration/">
                RenderingAcceleration
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/categories/Math/">
                Math
                <div class="category-count">4</div>
            </a>
        
            <a class="category-link" href="/categories/Shader/">
                Shader
                <div class="category-count">17</div>
            </a>
        
            <a class="category-link" href="/categories/Sync/">
                Sync
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Tags</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Animation/" rel="tag">Animation</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Atmospheric/" rel="tag">Atmospheric</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/BehaviorTree/" rel="tag">BehaviorTree</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Bump/" rel="tag">Bump</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Clound/" rel="tag">Clound</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Cull/" rel="tag">Cull</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DataStructure/" rel="tag">DataStructure</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Engine/" rel="tag">Engine</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/FrameSync/" rel="tag">FrameSync</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GAS/" rel="tag">GAS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GI/" rel="tag">GI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Game/" rel="tag">Game</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Grass/" rel="tag">Grass</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GrassEditor/" rel="tag">GrassEditor</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/HotUpdate/" rel="tag">HotUpdate</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/IBR/" rel="tag">IBR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Input/" rel="tag">Input</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Live2d/" rel="tag">Live2d</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Math/" rel="tag">Math</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Matrix/" rel="tag">Matrix</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/NPR/" rel="tag">NPR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Optimize/" rel="tag">Optimize</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Outline/" rel="tag">Outline</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PBR/" rel="tag">PBR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PostProcessing/" rel="tag">PostProcessing</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Quaternion/" rel="tag">Quaternion</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/RTR3rd/" rel="tag">RTR3rd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/RayTracing/" rel="tag">RayTracing</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ResourceCtrl/" rel="tag">ResourceCtrl</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SC2/" rel="tag">SC2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SDF/" rel="tag">SDF</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SRP/" rel="tag">SRP</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SSS/" rel="tag">SSS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Shader/" rel="tag">Shader</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/UGUI/" rel="tag">UGUI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/URP/" rel="tag">URP</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Vector/" rel="tag">Vector</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/XLua/" rel="tag">XLua</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/log/" rel="tag">log</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/novelai/" rel="tag">novelai</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%88%98%E6%96%97/" rel="tag">战斗</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E7%90%86%E8%AE%BA/" rel="tag">理论</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E9%85%8D%E7%BD%AE%E8%A1%A8/" rel="tag">配置表</a></li></ul>
    </div>
  </div>


    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       


<article id="post-DataStructure/空间数据结构" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        空间数据结构
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2023-01-02T11:06:29.000Z" itemprop="datePublished">2023-01-02</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">空间数据结构</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            24k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DataStructure/" rel="tag">DataStructure</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="空间数据结构"><a href="#空间数据结构" class="headerlink" title="空间数据结构"></a>空间数据结构</h1><p>在游戏程序中，利用空间数据结构加速计算往往是非常重要的优化思想，空间数据结构可以应用于场景管理、渲染、物理、游戏逻辑等方面<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/KillerAery/p/10878367.html">link</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/403554758">19.1 空间数据结构 - Justin的文章 - 知乎</a></p>
<h3 id="四叉树-八叉树"><a href="#四叉树-八叉树" class="headerlink" title="四叉树&#x2F;八叉树"></a>四叉树&#x2F;八叉树</h3><p>四叉树索引的基本思想是将地理空间递归划分为不同层次的树结构。<br>它将已知范围的空间等分成四个相等的子空间，如此递归下去，直至树的层次达到一定深度或者满足某种要求后停止分割<br><img src="https://pic4.zhimg.com/v2-c5c1bd8dc6ea2f6b0847949628f397ef_b.jpg"></p>
<h4 id="松散四叉树-八叉树：解决边界问题"><a href="#松散四叉树-八叉树：解决边界问题" class="headerlink" title="松散四叉树&#x2F;八叉树：解决边界问题"></a>松散四叉树&#x2F;八叉树：解决边界问题</h4><p><img src="https://pic3.zhimg.com/v2-6ac7face42d5517f8e2519299d2b5eae_b.jpg"><br>四叉树&#x2F;八叉树的一个问题是，物体有可能在边界处来回，从而导致物体总是在切换节点，从而不得不更新四叉树&#x2F;八叉树。</p>
<p>而松散四叉树&#x2F;八叉树正是解决这种边界问题的一种方式：<br>首先它定义一个节点有入口边界(inner boundary)，出口边界(outerboundary)。<br>那么如何判定一个物体现在在哪个节点呢？</p>
<p>若物体还没添加进四叉树&#x2F;八叉树，则检测现在位于哪个节点的入口边界内;<br>若物体先前已经存在于某个节点，则先检测现在是否越出该节点的出口边界，若越出再检测位于哪个节点的入口边界内。<br>在非松散的四叉树&#x2F;八叉树中，入口边界和出口边界是一样的。<br>而松散四叉树&#x2F;八叉树的松散，是指出口边界比入口边界要稍微宽些（各节点的出口边界也会发生部分重叠，松散比较符合这种描述），从而使节点不容易越过出口边界，减少了物体切换节点的次数</p>
<p><font color=#ffa500>在一篇关于松散四叉树&#x2F;八叉树的论文里，实验表明出口边界长度为入口边界2倍时可以表现得很好</font><br><a target="_blank" rel="noopener" href="https://www.mathematik.tu-clausthal.de/fileadmin/AG-StochastischeOptimierung/papers/LooseOctreePaper.pdf">link</a></p>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>· 场景管理<br><a href="../../../../../2022/07/25/DataStructure/%E5%9B%9B%E5%8F%89%E6%A0%91%E5%9C%BA%E6%99%AF%E5%8A%A0%E8%BD%BD">四叉树</a><br>· 碰撞检测<br>不同划分区域保证不会碰撞的情况下，就能快速过滤与本物体不同区域的其他潜在物体碰撞<br>· 光线追踪<br>用八叉树来划分3D空间区域，从而过滤掉大量不必要的区域<br><a target="_blank" rel="noopener" href="https://gitee.com/emmmm_no_think_it/spatial-data-structure">四叉树实现</a></p>
<hr>
<h3 id="层次包围盒树-BVH"><a href="#层次包围盒树-BVH" class="headerlink" title="层次包围盒树(BVH)"></a>层次包围盒树(BVH)</h3><p>层次包围盒树（BVH树）是一棵多叉树，用来存储包围盒形状。<br>它的根节点代表一个最大的包围盒，其多个子节点则代表多个子包围盒。</p>
<p>此外为了统一化层次包围盒树的形状，它只能存储同一种包围盒形状。</p>
<p>计算机的包围盒形状有球体&#x2F;AABB&#x2F;OBB&#x2F;k-DOP，若不清楚这些形状术语可以自行搜索了解。</p>
<p>常用的层次包围盒树有AABB层次包围盒树和球体树。</p>
<hr>
<h4 id="AABB包围盒树"><a href="#AABB包围盒树" class="headerlink" title="AABB包围盒树"></a>AABB包围盒树</h4><p>把不同形状粗略用AABB形状围起来看作一个AABB形状（为了统一化形状），然后才建立层次AABB包围盒树<br><img src="/showImg/show104.png" alt="Image text"><br>在物理引擎里，由于物理模拟，大部分形状都是会动态更新的，例如位移&#x2F;旋转都会改变形状。于是就又有一种支持动态更新的层次包围盒树，称之为动态层次包围盒树。它的算法核心大概：形状的位移&#x2F;旋转&#x2F;伸缩更新对应的叶节点，然后一级一级更新上面的节点，使它们的包围体包住子节点<br><a target="_blank" rel="noopener" href="https://gitee.com/emmmm_no_think_it/spatial-data-structure">层次包围盒实现</a></p>
<hr>
<h4 id="球体包围盒树"><a href="#球体包围盒树" class="headerlink" title="球体包围盒树"></a>球体包围盒树</h4><p>球体是最容易计算的一类包围盒，而且球体树构造速度可以很快，因此球体树可被用作粗略松散但快速的空间划分结构(复杂物体计算圆心挺麻烦的…)</p>
<h5 id="构建步骤"><a href="#构建步骤" class="headerlink" title="构建步骤"></a>构建步骤</h5><ol>
<li>计算出包围所有三角边顶点的最小球体包围盒，作为根节点</li>
<li>以球心为坐标系原点，其坐标系X轴划分在该X轴左右的三角形，并将这些分别放入左子节点、右子节点中</li>
<li>重复步骤1、2，最后得到一颗球体树</li>
</ol>
<p>在步骤2中，还可以按X轴、Y轴、Z轴的顺序轮流划分，即第一次步骤2划分用X轴，第二次步骤2划分用Y轴</p>
<p><img src="/showImg/show105.jpg" alt="Image text"><br>球体树粗糙，但是平衡效果不差，且它构造时间复杂度只有O(NlogN)</p>
<hr>
<h4 id="动态层次包围盒"><a href="#动态层次包围盒" class="headerlink" title="动态层次包围盒"></a>动态层次包围盒</h4><h5 id="构建步骤-1"><a href="#构建步骤-1" class="headerlink" title="构建步骤"></a>构建步骤</h5><p>1.构建一个初始的BVH：使用一种构建算法（例如SAH、Binned SAH等），将所有物体递归地分割成较小的组，并将这些组放入树中的叶子节点中。在这个过程中，您需要为每个节点计算它所包含的物体的包围盒<br>2.监听物体变化：如果您的应用程序中的物体是动态的，那么您需要能够监听它们的变化（例如，当物体的位置或形状发生变化时）。一旦发现这些变化，您需要执行下面的步骤<br>3.更新叶节点：找到包含被修改物体的叶节点，并更新它的包围盒。这可能会导致该节点的父节点和祖先节点的包围盒也需要更新<br>4.展开树：从被修改物体的叶节点开始，展开整个树，一直到根节点。对于每个节点，您需要计算其子节点的包围盒，然后更新该节点的包围盒。这可能会导致该节点的父节点和祖先节点的包围盒也需要更新<br>5.重建树：如果在展开树的过程中发现某些节点不再满足BVH的质量标准（例如，SAH或Binned SAH），则需要对这些节点进行重建。重建过程涉及到递归地将节点分割成更小的组，并创建新的节点来替换旧节点</p>
<p><img src="/showImg/BVH/show1.gif" alt="Image text"></p>
<details>
<summary>节点的添加</summary>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InsertNode</span>(<span class="params">Node node</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        root = node;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    InsertNode(root, node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InsertNode</span>(<span class="params">Node node, Node newNode</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (node.isLeaf)</span><br><span class="line">    &#123;</span><br><span class="line">        Node newParent = <span class="keyword">new</span> Node();</span><br><span class="line">        newParent.parent = node.parent;</span><br><span class="line"></span><br><span class="line">        newNode.parent = newParent;</span><br><span class="line">        <span class="keyword">if</span> (root == node)</span><br><span class="line">        &#123;</span><br><span class="line">            root = newParent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (node.parent.left == node)</span><br><span class="line">            &#123;</span><br><span class="line">                node.parent.left = newParent;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (node.parent.right == node)</span><br><span class="line">            &#123;</span><br><span class="line">                node.parent.right = newParent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        node.parent = newParent;</span><br><span class="line"></span><br><span class="line">        newParent.left = node;</span><br><span class="line">        newParent.right = newNode;</span><br><span class="line"></span><br><span class="line">        newParent.aabb = AABB.CreateByAABB(node.aabb, newNode.aabb);</span><br><span class="line">        Node parent = newParent.parent;</span><br><span class="line">        <span class="keyword">while</span> (parent != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            parent.UpdateAABB();</span><br><span class="line">            parent = parent.parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (node.left == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        node.left = newNode;</span><br><span class="line">        newNode.parent = node;</span><br><span class="line">        Node parent = newNode.parent;</span><br><span class="line">        <span class="keyword">while</span> (parent != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            parent.UpdateAABB();</span><br><span class="line">            parent = parent.parent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (node.right == <span class="literal">null</span>) &#123;</span><br><span class="line">        node.right = newNode;</span><br><span class="line">        newNode.parent = node;</span><br><span class="line">        Node parent = newNode.parent;</span><br><span class="line">        <span class="keyword">while</span> (parent != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            parent.UpdateAABB();</span><br><span class="line">            parent = parent.parent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        AABB combinedAABB = AABB.CreateByAABB(node.aabb, newNode.aabb);</span><br><span class="line">        <span class="comment">//float currentCost = 2 * node.aabb.GetSurfaceArea();</span></span><br><span class="line">        <span class="built_in">float</span> combinedCost = <span class="number">2</span> * combinedAABB.GetSurfaceArea();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">float</span> leftCost = AABB.CreateByAABB(node.left.aabb, newNode.aabb).GetSurfaceArea() + combinedCost - node.left.aabb.GetSurfaceArea();</span><br><span class="line">        <span class="built_in">float</span> rightCost = AABB.CreateByAABB(node.right.aabb, newNode.aabb).GetSurfaceArea() + combinedCost - node.right.aabb.GetSurfaceArea();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (leftCost &lt; rightCost)</span><br><span class="line">        &#123;</span><br><span class="line">            InsertNode(node.left, newNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            InsertNode(node.right, newNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</details>

<details>
<summary>节点的删除</summary>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RemoveNode</span>(<span class="params">Node node, GameObject obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node.gameObject == obj)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.isLeaf)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (node == root)</span><br><span class="line">            &#123;</span><br><span class="line">                root = <span class="literal">null</span>;</span><br><span class="line">                node.parent = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (node.parent.left == node)</span><br><span class="line">            &#123;</span><br><span class="line">                node.parent.left = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                node.parent.right = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Node parent = node.parent;</span><br><span class="line">        <span class="keyword">while</span> (parent != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (parent.left != <span class="literal">null</span> &amp;&amp; parent.right != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                parent.aabb = AABB.CreateByAABB(parent.left.aabb, parent.right.aabb);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (parent.left != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                parent.aabb = <span class="keyword">new</span> AABB(parent.left.aabb.bounds);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (parent.right != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                parent.aabb = <span class="keyword">new</span> AABB(parent.right.aabb.bounds);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent.parent!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (parent.parent.left == parent)</span><br><span class="line">                    &#123;</span><br><span class="line">                        parent.parent.left = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        parent.parent.right = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            parent = parent.parent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.isLeaf == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveNode(node.left, obj);</span><br><span class="line">            RemoveNode(node.right, obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<details>
<summary>节点的更新</summary>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateObject</span>(<span class="params">GameObject obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    RemoveObject(obj);</span><br><span class="line">    AddObject(obj);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</details>

<hr>
<h4 id="层次包围盒树的应用"><a href="#层次包围盒树的应用" class="headerlink" title="层次包围盒树的应用"></a>层次包围盒树的应用</h4><h5 id="1-碰撞检测"><a href="#1-碰撞检测" class="headerlink" title="1.碰撞检测"></a>1.碰撞检测</h5><p>在Bullet、Havok等物理引擎的碰撞粗测阶段，使用一种叫做 动态层次AABB包围盒树(Dynamic Bounding Volume Hierarchy Based On AABB Tree) 的结构来存储动态的AABB形状。<br>然后通过该包围盒树的性质（不同父包围盒必定不会碰撞），快速过滤大量不可能发生碰撞的形状对</p>
<h5 id="2-射线检测-挑选几何体"><a href="#2-射线检测-挑选几何体" class="headerlink" title="2.射线检测&#x2F;挑选几何体"></a>2.射线检测&#x2F;挑选几何体</h5><p>射线检测从层次包围盒树自顶向下检测是否射线通过包围盒，若不通过则无需检测其子包围盒。<br>这种剪裁可让每次射线检测平均只需检测O(logN)数量的形状。<br>通过一个点位置快速挑选该点的几何体也是类似的原理</p>
<h5 id="3-视锥剔除"><a href="#3-视锥剔除" class="headerlink" title="3.视锥剔除"></a>3.视锥剔除</h5><p>对BVH树进行中序遍历的视锥测试，如果一个节点所代表的包围盒不在视锥范围内，那么其所有子节点所代表的包围盒都不会在视锥范围内，则可以跳过测试其子节点。在这个遍历过程中，通过测试的节点所代表的几何体才可以发送渲染命令</p>
<h5 id="4-光线追踪过滤"><a href="#4-光线追踪过滤" class="headerlink" title="4.光线追踪过滤"></a>4.光线追踪过滤</h5><p>光线追踪渲染，可使用BVH来进行基于物体的划分，这样光线测试也可以过滤掉大量不必要的碰撞物体，效率一般比基于空间的划分还要好上一些</p>
<details>
<summary>101中的部分截图</summary>

<p><img src="/showImg/show109.png" alt="Image text"><br><img src="/showImg/show110.png" alt="Image text"></p>
<p><img src="/showImg/show106.png" alt="Image text"><br><img src="/showImg/show107.png" alt="Image text"><br><img src="/showImg/show108.png" alt="Image text"></p>
</details>

<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv21433924?spm_id_from=333.999.0.0">通过BVH(aabb)在光线追踪中过滤物体</a></p>
<details>
<summary>AABB核心代码</summary>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#ifndef AABB_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AABB_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;rtweekend.h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">aabb</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        point3 minimum;</span><br><span class="line">        point3 maximum;</span><br><span class="line"></span><br><span class="line">        aabb() &#123;&#125;</span><br><span class="line">        aabb(<span class="keyword">const</span> point3&amp; a, <span class="keyword">const</span> point3&amp; b) &#123; minimum = a; maximum = b;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">point3 <span class="title">min</span>() <span class="keyword">const</span></span> &#123;<span class="keyword">return</span> minimum; &#125;</span><br><span class="line">        <span class="function">point3 <span class="title">max</span>() <span class="keyword">const</span></span> &#123;<span class="keyword">return</span> maximum; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">hit</span>(<span class="params"><span class="keyword">const</span> ray&amp; r, <span class="built_in">double</span> t_min, <span class="built_in">double</span> t_max</span>) <span class="keyword">const</span></span> =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//计算包裹两个包围盒的大包围盒</span></span><br><span class="line">		<span class="function">aabb <span class="title">surrounding_box</span>(<span class="params">aabb box0,aabb box1</span>)</span>&#123;</span><br><span class="line">			<span class="function">point3 <span class="title">small</span>(<span class="params">fmin(box0.min(</span>).<span class="title">x</span>(), box1.<span class="title">min</span>().<span class="title">x</span>()),</span></span><br><span class="line"><span class="function">						<span class="title">fmin</span>(<span class="params">box0.min(</span>).<span class="title">y</span>(), box1.<span class="title">min</span>().<span class="title">y</span>()),</span></span><br><span class="line"><span class="function">						<span class="title">fmin</span>(<span class="params">box0.min(</span>).<span class="title">z</span>(), box1.<span class="title">min</span>().<span class="title">z</span>()))</span>;</span><br><span class="line"></span><br><span class="line">			<span class="function">point3 <span class="title">big</span>(<span class="params">fmax(box0.max(</span>).<span class="title">x</span>(), box1.<span class="title">max</span>().<span class="title">x</span>()),</span></span><br><span class="line"><span class="function">					<span class="title">fmax</span>(<span class="params">box0.max(</span>).<span class="title">y</span>(), box1.<span class="title">max</span>().<span class="title">y</span>()),</span></span><br><span class="line"><span class="function">					<span class="title">fmax</span>(<span class="params">box0.max(</span>).<span class="title">z</span>(), box1.<span class="title">max</span>().<span class="title">z</span>()))</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> aabb(small,big);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检测射线和AABB的碰撞</span></span><br><span class="line">inline <span class="built_in">bool</span> aabb::hit(<span class="keyword">const</span> ray&amp; r, <span class="built_in">double</span> t_min, <span class="built_in">double</span> t_max) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> a = <span class="number">0</span>; a &lt; <span class="number">3</span>; a++) &#123;</span><br><span class="line">        auto invD = <span class="number">1.0f</span> / r.direction()[a];</span><br><span class="line">        auto t0 = (min()[a] - r.origin()[a]) * invD;</span><br><span class="line">        auto t1 = (max()[a] - r.origin()[a]) * invD;</span><br><span class="line">        <span class="keyword">if</span> (invD &lt; <span class="number">0.0f</span>)</span><br><span class="line">            std::swap(t0, t1);</span><br><span class="line">        t_min = t0 &gt; t_min ? t0 : t_min;</span><br><span class="line">        t_max = t1 &lt; t_max ? t1 : t_max;</span><br><span class="line">        <span class="keyword">if</span> (t_max &lt;= t_min)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</details>

<details>
<summary>BVH核心代码</summary>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#ifndef BVH_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BVH_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;rtweekend.h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;hittable.h&quot;</span></span><br><span class="line"><span class="meta">#include &quot;hittable_list.h&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">bvh_node</span> : <span class="title">public</span> <span class="title">hittable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        bvh_node();</span><br><span class="line"></span><br><span class="line">        bvh_node(<span class="keyword">const</span> hittable_list&amp; list, <span class="built_in">double</span> time0, <span class="built_in">double</span> time1)</span><br><span class="line">            : bvh_node(list.objects, <span class="number">0</span>, list.objects.size(), time0, time1)</span><br><span class="line">        &#123;&#125;</span><br><span class="line"></span><br><span class="line">        bvh_node(</span><br><span class="line">            <span class="keyword">const</span> std::vector&lt;shared_ptr&lt;hittable&gt;&gt;&amp; src_objects,</span><br><span class="line">            size_t start, size_t end, <span class="built_in">double</span> time0, <span class="built_in">double</span> time1);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">hit</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">const</span> ray&amp; r, <span class="built_in">double</span> t_min, <span class="built_in">double</span> t_max, hit_record&amp; rec</span>) <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">bounding_box</span>(<span class="params"><span class="built_in">double</span> time0, <span class="built_in">double</span> time1, aabb&amp; output_box</span>) <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        shared_ptr&lt;hittable&gt; left;</span><br><span class="line">        shared_ptr&lt;hittable&gt; right;</span><br><span class="line">        aabb box;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">bool</span> bvh_node::bounding_box(<span class="built_in">double</span> time0, <span class="built_in">double</span> time1, aabb&amp; output_box) <span class="keyword">const</span> &#123;</span><br><span class="line">    output_box = box;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回最近的碰撞信息，如果有节点成功，则为true</span></span><br><span class="line"><span class="built_in">bool</span> bvh_node::hit(<span class="keyword">const</span> ray&amp; r, <span class="built_in">double</span> t_min, <span class="built_in">double</span> t_max, hit_record&amp; rec) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!box.hit(r, t_min, t_max))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> hit_left = left-&gt;hit(r, t_min, t_max, rec);</span><br><span class="line">    <span class="built_in">bool</span> hit_right = right-&gt;hit(r, t_min, hit_left ? rec.t : t_max, rec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hit_left || hit_right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">inline <span class="built_in">bool</span> <span class="title">box_compare</span>(<span class="params"><span class="keyword">const</span> shared_ptr&lt;hittable&gt; a, <span class="keyword">const</span> shared_ptr&lt;hittable&gt; b, <span class="built_in">int</span> axis</span>)</span> &#123;</span><br><span class="line">    aabb box_a;</span><br><span class="line">    aabb box_b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!a-&gt;bounding_box(<span class="number">0</span>,<span class="number">0</span>, box_a) || !b-&gt;bounding_box(<span class="number">0</span>,<span class="number">0</span>, box_b))</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;No bounding box in bvh_node constructor.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> box_a.min().e[axis] &lt; box_b.min().e[axis];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">box_x_compare</span> (<span class="params"><span class="keyword">const</span> shared_ptr&lt;hittable&gt; a, <span class="keyword">const</span> shared_ptr&lt;hittable&gt; b</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> box_compare(a, b, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">box_y_compare</span> (<span class="params"><span class="keyword">const</span> shared_ptr&lt;hittable&gt; a, <span class="keyword">const</span> shared_ptr&lt;hittable&gt; b</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> box_compare(a, b, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">box_z_compare</span> (<span class="params"><span class="keyword">const</span> shared_ptr&lt;hittable&gt; a, <span class="keyword">const</span> shared_ptr&lt;hittable&gt; b</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> box_compare(a, b, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bvh树的构建</span></span><br><span class="line">bvh_node::bvh_node(</span><br><span class="line">    std::vector&lt;shared_ptr&lt;hittable&gt;&gt;&amp; src_objects,</span><br><span class="line">    size_t start, size_t end, <span class="built_in">double</span> time0, <span class="built_in">double</span> time1</span><br><span class="line">) &#123;</span><br><span class="line">    auto objects = src_objects; <span class="comment">// Create a modifiable array of the source scene objects</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> axis = random_int(<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">    auto comparator = (axis == <span class="number">0</span>) ? box_x_compare</span><br><span class="line">                    : (axis == <span class="number">1</span>) ? box_y_compare</span><br><span class="line">                                  : box_z_compare;</span><br><span class="line"></span><br><span class="line">    size_t object_span = end - start;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (object_span == <span class="number">1</span>) &#123;</span><br><span class="line">        left = right = objects[start];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object_span == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparator(objects[start], objects[start+<span class="number">1</span>])) &#123;</span><br><span class="line">            left = objects[start];</span><br><span class="line">            right = objects[start+<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            left = objects[start+<span class="number">1</span>];</span><br><span class="line">            right = objects[start];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::sort(objects.begin() + start, objects.begin() + end, comparator);</span><br><span class="line"></span><br><span class="line">        auto mid = start + object_span/<span class="number">2</span>;</span><br><span class="line">        left = make_shared&lt;bvh_node&gt;(objects, start, mid, time0, time1);</span><br><span class="line">        right = make_shared&lt;bvh_node&gt;(objects, mid, end, time0, time1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    aabb box_left, box_right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (  !left-&gt;bounding_box (time0, time1, box_left)</span><br><span class="line">       || !right-&gt;bounding_box(time0, time1, box_right)</span><br><span class="line">    )</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;No bounding box in bvh_node constructor.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    box = surrounding_box(box_left, box_right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</details>

<h5 id="5-辅助BSP树的构建"><a href="#5-辅助BSP树的构建" class="headerlink" title="5.辅助BSP树的构建"></a>5.辅助BSP树的构建</h5><p>在BSP树的构建中，利用球体树辅助，可以将复杂度从O(Nlog^2^N)下降为O(NlogN)的复杂度</p>
<h4 id="BSP树"><a href="#BSP树" class="headerlink" title="BSP树"></a>BSP树</h4><p>随时渲染硬件的进步，基于BSP树的渲染慢慢淘汰。但是即使在今天，BSP仍是在其他分支（引擎编辑器）不可或缺的一个重要数据结构<br>在计算机图形学中以两种明显不同的形式存在，轴对齐树、多边形对齐树<br>BSP tree在3D空间下其每个节点表示一个平面，其代表的平面将当前空间划分为前向和背向两个子空间，分别对应左儿子和右儿子。<br>2D空间下，BSP树每个节点则表示一条边，也可以将2D空间划分成前后两部分</p>
<h5 id="多边形对齐BSP"><a href="#多边形对齐BSP" class="headerlink" title="多边形对齐BSP"></a>多边形对齐BSP</h5><p><img src="/showImg/BVH/show1.jpg" alt="Image text"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BSPTree</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> m_MaxIteration;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> m_NodeCapacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;BSPTreeNode&gt; m_Nodes = <span class="keyword">new</span> List&lt;BSPTreeNode&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Divide</span>(<span class="params">IList&lt;float2&gt; _points,<span class="keyword">out</span> G2Plane _plane,<span class="keyword">out</span> List&lt;float2&gt; _front,<span class="keyword">out</span> List&lt;float2&gt; _back</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UPrincipleComponentAnalysis.Evaluate(_points,<span class="keyword">out</span> <span class="keyword">var</span> centre,<span class="keyword">out</span> <span class="keyword">var</span> right,<span class="keyword">out</span> <span class="keyword">var</span> up);</span><br><span class="line">        _plane = <span class="keyword">new</span> G2Plane(up,centre);</span><br><span class="line">        _front = <span class="keyword">new</span> List&lt;float2&gt;();</span><br><span class="line">        _back = <span class="keyword">new</span> List&lt;float2&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> point <span class="keyword">in</span> _points)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(_plane.IsPointFront(point))</span><br><span class="line">                _front.Add(point);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                _back.Add(point);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Construct</span>(<span class="params">IList&lt;float2&gt; _points, <span class="built_in">int</span> _maxIteration, <span class="built_in">int</span> _nodeCapacity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_Nodes.Clear();</span><br><span class="line">        m_Nodes.Add(<span class="keyword">new</span> BSPTreeNode()</span><br><span class="line">        &#123;</span><br><span class="line">            m_Iteration = <span class="number">0</span>,</span><br><span class="line">            m_Plane = G2Plane.kDefault,</span><br><span class="line">            m_Points = <span class="keyword">new</span> List&lt;float2&gt;(_points),</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">bool</span> doBreak = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (doBreak)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">bool</span> splited = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_Nodes.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> node = m_Nodes[i];</span><br><span class="line">                <span class="keyword">if</span> (node.m_Iteration &gt;= _maxIteration)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (node.m_Points.Count &lt; _nodeCapacity)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                Divide(node.m_Points,<span class="keyword">out</span> <span class="keyword">var</span> dividePlane,<span class="keyword">out</span> <span class="keyword">var</span> frontPoints,<span class="keyword">out</span> <span class="keyword">var</span> backPoints);</span><br><span class="line">                </span><br><span class="line">                m_Nodes.Add(<span class="keyword">new</span> BSPTreeNode()</span><br><span class="line">                &#123;</span><br><span class="line">                    m_Iteration = node.m_Iteration + <span class="number">1</span>,</span><br><span class="line">                    m_Plane = dividePlane,</span><br><span class="line">                    m_Points = frontPoints,</span><br><span class="line">                    front = <span class="literal">true</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">                </span><br><span class="line">                m_Nodes.Add(<span class="keyword">new</span> BSPTreeNode()</span><br><span class="line">                &#123;</span><br><span class="line">                    m_Iteration = node.m_Iteration + <span class="number">1</span>,</span><br><span class="line">                    m_Plane = dividePlane,</span><br><span class="line">                    m_Points = backPoints,</span><br><span class="line">                    front = <span class="literal">false</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">                </span><br><span class="line">                m_Nodes.RemoveAt(i);</span><br><span class="line">                splited = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            doBreak = splited;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DrawGizmos</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> matrix = Gizmos.matrix;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> node <span class="keyword">in</span> m_Nodes)</span><br><span class="line">        &#123;</span><br><span class="line">            Gizmos.color = UColor.IndexToColor(index++ % <span class="number">6</span>);</span><br><span class="line">            Gizmos.matrix = matrix;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> point <span class="keyword">in</span> node.m_Points)</span><br><span class="line">                Gizmos.DrawWireSphere(point.to3xz(),<span class="number">.1</span>f);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (node.front)</span><br><span class="line">            &#123;</span><br><span class="line">                Gizmos.matrix = matrix * Matrix4x4.TRS(node.m_Plane.position.to3xz(),Quaternion.LookRotation(node.m_Plane.normal.to3xz()),Vector3.one );</span><br><span class="line">                Gizmos.DrawWireCube(Vector3.zero,(Vector3.right + Vector3.up)*<span class="number">5f</span>);</span><br><span class="line">                UGizmos.DrawString(Vector3.zero, node.m_Iteration.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Gizmos.matrix = matrix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">UPrincipleComponentAnalysis</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Evaluate</span>(<span class="params">IEnumerable&lt;float3&gt; _points,<span class="keyword">out</span> float3 _centre, <span class="keyword">out</span> float3 _right, <span class="keyword">out</span> float3 _up, <span class="keyword">out</span> float3 _forward</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _right = kfloat3.right;</span><br><span class="line">        _up = kfloat3.up;</span><br><span class="line">        _forward = kfloat3.forward;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> m = _points.Average();</span><br><span class="line">        <span class="keyword">var</span> a00 = <span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">var</span> a11 = <span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">var</span> a22 =<span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">var</span> a01mirror = <span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">var</span> a02mirror = <span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">var</span> a12mirror = <span class="number">0f</span>;</span><br><span class="line">        <span class="built_in">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> p <span class="keyword">in</span> _points)</span><br><span class="line">        &#123;</span><br><span class="line">            count++;</span><br><span class="line">            a00+=umath.pow2(p.x - m.x);</span><br><span class="line">            a11+=umath.pow2(p.y - m.y);</span><br><span class="line">            a22+=umath.pow2(p.z - m.z);</span><br><span class="line"></span><br><span class="line">            a01mirror += (p.x - m.x)*(p.y-m.y);</span><br><span class="line">            a02mirror += (p.x - m.x)*(p.z-m.z);</span><br><span class="line">            a12mirror += (p.y - m.y)*(p.z-m.z);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> matrix =  <span class="keyword">new</span> float3x3(a00,a01mirror,a02mirror,</span><br><span class="line">                                            a01mirror,a11,a12mirror,</span><br><span class="line">                                                a02mirror,a12mirror,a22)/count;</span><br><span class="line">        _centre = m;</span><br><span class="line">        matrix.GetEigenVectors(<span class="keyword">out</span> _right,<span class="keyword">out</span> _up,<span class="keyword">out</span> _forward);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Evaluate</span>(<span class="params">IList&lt;float2&gt; _points,<span class="keyword">out</span> float2 _centre, <span class="keyword">out</span> float2 _R, <span class="keyword">out</span> float2 _S</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _R = kfloat2.up;</span><br><span class="line">        _S = kfloat2.right;</span><br><span class="line"></span><br><span class="line">        _centre = _points.Average();</span><br><span class="line">        <span class="keyword">var</span> m = _centre;</span><br><span class="line">        <span class="keyword">var</span> a00 = _points.Average(p =&gt; umath.pow2(p.x - m.x));</span><br><span class="line">        <span class="keyword">var</span> a11 = _points.Average(p =&gt; umath.pow2(p.y - m.y));</span><br><span class="line">        <span class="keyword">var</span> a01mirror = _points.Average(p =&gt; (p.x - m.x)*(p.y-m.y));</span><br><span class="line">        <span class="keyword">new</span> float2x2(a00,a01mirror,a01mirror,a11).GetEigenVectors(<span class="keyword">out</span> _R,<span class="keyword">out</span> _S);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">这段代码的理论基础涉及到主成分分析（Principal Component Analysis，PCA）。PCA 是一种常用的数据降维和特征提取方法，它通过找到数据的主要方向（主成分）来揭示数据的内在结构。</span><br><span class="line">具体来说，这段代码使用了以下步骤：</span><br><span class="line"><span class="number">1.</span>计算均值 (m): 通过计算输入点集的均值，找到点集的中心。</span><br><span class="line"><span class="number">2.</span>计算协方差矩阵 (matrix): 使用每个点与均值的差值构建协方差矩阵。协方差矩阵描述了不同维度之间的关系，即数据的分散情况。</span><br><span class="line"><span class="number">3.</span>获取特征向量 (_right, _up, _forward): 通过求解协方差矩阵的特征向量，找到数据分布的主要方向。特征向量表示数据在新坐标系中的方向，而特征值则表示数据在相应方向上的方差。</span><br><span class="line"><span class="number">4.</span>输出结果 (_centre, _right, _up, _forward): 将中心点和主方向向量作为输出，这些向量可用于描述数据的形状和分布。</span><br><span class="line">总的来说，PCA 的核心思想是通过找到数据中方差最大的方向，以及与之正交的次要方向，来描述数据的主要特征。在这个代码中，通过计算协方差矩阵的特征向量，实现了对数据分布主方向的提取</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>多边形对齐的BSP树有一些有用的属性。 一个是，对于给定的视图，树结构可以严格从后到前(或从前到后)遍历。 这与轴对齐的BSP树相比，后者通常只给出粗略排序的顺序。 确定相机位于根平面的哪一边。 在这个远平面的多边形集合在平表面的集合之外。 对于远平面，采取下一层的划分平面，并确定相机在哪一边。 远平面的子集也是离摄像机最远的子集。 通过继续递归，这个过程建立了严格的前后顺序，可以使用画家的算法来渲染场景。 画家的算法不需要z缓冲区。 如果所有对象都是按照前后顺序绘制的，那么每一个较近的对象就会被画在它后面的对象的前面，这样就不需要z-depth比较了。<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/403554758">link</a></p>
<h5 id="轴对齐BSP树-K-D树"><a href="#轴对齐BSP树-K-D树" class="headerlink" title="轴对齐BSP树(K-D树)"></a>轴对齐BSP树(K-D树)</h5><p><img src="https://pic2.zhimg.com/v2-2dae685b5443e6978ae112484d10eeb5_b.jpg"><br>整个场景被包围在一个轴对齐的包围盒(AABB)中。 接下来的想法是递归地将这个包围盒划分为更小的包围盒<br>粗略的前后排序是如何使用轴对齐BSP树的一个例子。 这对于遮挡剔除算法是有用的(章节19.7和23.7)，以及通过最小化像素overdraw来减少像素着色器成本。 假设当前遍历一个名为N的节点。 这里，N是遍历开始时的根。 检查N的分割平面，然后递归地在查看器所在平面的一侧继续遍历树。 因此，只有当整个树的一半被遍历时，我们才开始遍历另一边。 由于叶节点的内容没有排序，而且对象可能位于树的许多节点中，因此这种遍历不会给出精确的前后排序。 然而，它给出了一个粗略的排序，这通常是有用的。 与观察者的位置相比，从节点平面的另一侧开始遍历，可以得到粗略的前后排序。 这对于透明排序很有用。 BSP遍历也可以用来测试光线对场景几何的影响，射线的位置只是用来交换观察者的位置<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/403554758">link</a></p>
<h5 id="K-DOP"><a href="#K-DOP" class="headerlink" title="K-DOP"></a>K-DOP</h5><p>KSP的一种<br><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.27/zh-CN/InteractiveExperiences/Physics/Collision/HowTo/AddDOP/">UE4 K-DOP</a><br><a target="_blank" rel="noopener" href="https://assetstore.unity.com/packages/tools/utilities/k-dop-collision-hull-generator-70132">AssetStore</a><br><img src="https://docs.unrealengine.com/4.27/Images/InteractiveExperiences/Physics/Collision/HowTo/kdop_sizes.webp" alt="Image Text"></p>
<p>k-DOP是一种包围体，是K离散导向多面体（K discrete oriented polytope）的缩写，它是沿着K个方向的范围的布尔交集(zhuanlan.zhihu.com)(docs.unrealengine.com)。也就是说，一个k-DOP是k个包围平板的布尔交集，是一个包含对象的凸多面体（在2-D中是多边形，在3-D中是多面体）(en.wikipedia.org)。</p>
<p>要构建一个k-DOP，首先要选择k个方向，通常是沿着主轴或对角线的正负方向。然后，对于每个方向，计算对象上的所有顶点在该方向上的最小和最大投影值。这些值定义了沿着该方向的一个包围平板。最后，将所有的包围平板相交，得到一个k-DOP。</p>
<details>
<summary>Bing大小姐给的代码</summary>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Assume obj is a list of vertices of the object</span></span><br><span class="line"><span class="comment"># Assume dot(v, n) is a function that computes the dot product of vector v and n</span></span><br><span class="line"><span class="comment"># Assume intersect(s1, s2) is a function that computes the intersection of two slabs s1 and s2</span></span><br><span class="line"><span class="comment"># Assume slab(n, min, max) is a function that creates a slab with normal n and min/max values along n</span></span><br><span class="line"><span class="comment"># Define the 26 directions as unit vectors</span></span><br><span class="line">dirs = [(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), (-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), (<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), (<span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>), (<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>),</span><br><span class="line">    (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>), (-<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>), (<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>), (-<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    (<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>), (-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>), (<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>), (-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    (<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>), (<span class="number">0</span>, -<span class="number">1</span>, -<span class="number">1</span>), (<span class="number">0</span>, <span class="number">1</span>, -<span class="number">1</span>), (<span class="number">0</span>, -<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    (sqrt(<span class="number">3</span>)/<span class="number">3</span>, sqrt(<span class="number">3</span>)/<span class="number">3</span>, sqrt(<span class="number">3</span>)/<span class="number">3</span>), (-sqrt(<span class="number">3</span>)/<span class="number">3</span>,-sqrt(<span class="number">3</span>)/<span class="number">3</span>,-sqrt(<span class="number">3</span>)/<span class="number">3</span>),</span><br><span class="line">    (sqrt(<span class="number">3</span>)/<span class="number">3</span>,-sqrt(<span class="number">3</span>)/<span class="number">3</span>,-sqrt(<span class="number">3</span>)/<span class="number">3</span>), (-sqrt(<span class="number">3</span>)/<span class="number">3</span>,sqrt(<span class="number">3</span>)/<span class="number">3</span>,sqrt(<span class="number">3</span>)/<span class="number">3</span>),</span><br><span class="line">    (sqrt(<span class="number">3</span>)/<span class="number">3</span>,sqrt(<span class="number">3</span>)/<span class="number">3</span>,-sqrt(<span class="number">3</span>)/<span class="number">3</span>), (-sqrt(<span class="number">3</span>)/<span class="number">3</span>,-sqrt(<span class="number">3</span>)/<span class="number">3</span>,sqrt(<span class="number">3</span>)/<span class="number">3</span>),</span><br><span class="line">    (sqrt(<span class="number">3</span>)/<span class="number">3</span>,-sqrt(<span class="number">3</span>)/<span class="number">3</span>,sqrt(<span class="number">3</span>)/<span class="number">3</span>), (-sqrt(<span class="number">3</span>)/<span class="number">3</span>,sqrt(<span class="number">3</span>)/<span class="number">3</span>,-sqrt(<span class="number">3</span>)/<span class="number">3</span>)]</span><br><span class="line"><span class="comment"># Initialize the k-DOP as an empty list</span></span><br><span class="line">kdop = []</span><br><span class="line"><span class="comment"># For each direction</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> dirs:</span><br><span class="line">    <span class="comment"># Initialize the min and max values as infinity and negative infinity</span></span><br><span class="line">    <span class="built_in">min</span> = inf</span><br><span class="line">    <span class="built_in">max</span> = -inf</span><br><span class="line">    <span class="comment"># For each vertex of the object</span></span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> obj:</span><br><span class="line">        <span class="comment"># Compute the projection value along n</span></span><br><span class="line">        p = dot(v,n)</span><br><span class="line">    <span class="comment"># Update the min and max values if needed</span></span><br><span class="line">    <span class="keyword">if</span> p &lt; <span class="built_in">min</span>:</span><br><span class="line">        <span class="built_in">min</span> = p</span><br><span class="line">    <span class="keyword">if</span> p &gt; <span class="built_in">max</span>:</span><br><span class="line">        <span class="built_in">max</span> = p</span><br><span class="line">    <span class="comment"># Create a slab with normal n and min/max values along n</span></span><br><span class="line">    s = slab(n,<span class="built_in">min</span>,<span class="built_in">max</span>)</span><br><span class="line">    <span class="comment"># Add the slab to the k-DOP</span></span><br><span class="line">    kdop.append(s)</span><br><span class="line">    <span class="comment"># Intersect all the slabs in the k-DOP to get the final shape</span></span><br><span class="line">    shape = kdop[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(kdop)):</span><br><span class="line">        shape = intersect(shape,kdop[i])</span><br><span class="line"><span class="comment"># Return the shape as the k-DOP</span></span><br><span class="line"><span class="keyword">return</span></span><br></pre></td></tr></table></figure>

</details>

<details>
<summary>插件的思路</summary>

<p>1.数据的定义</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Math.Sqrt(2)/2</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> rcpSqrt2 = <span class="number">0.70710678118f</span>;</span><br><span class="line"><span class="comment">// Math.Sqrt(3)/3</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> rcpSqrt3 = <span class="number">0.57735026919f</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] Dir10X = <span class="keyword">new</span> Vector3[]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, rcpSqrt2, rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, rcpSqrt2, -rcpSqrt2),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] Dir10Y = <span class="keyword">new</span> Vector3[]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, <span class="number">0.0f</span>, rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, <span class="number">0.0f</span>, -rcpSqrt2),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] KDopDir10Z = <span class="keyword">new</span> Vector3[]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, rcpSqrt2, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, -rcpSqrt2, <span class="number">0.0f</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] KDopDir18 = <span class="keyword">new</span> Vector3[]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, rcpSqrt2, rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, rcpSqrt2, -rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, <span class="number">0.0f</span>, rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, <span class="number">0.0f</span>, -rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, rcpSqrt2, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, -rcpSqrt2, <span class="number">0.0f</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] KDopDir26 = <span class="keyword">new</span> Vector3[]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, rcpSqrt2, rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, rcpSqrt2, -rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, <span class="number">0.0f</span>, rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, <span class="number">0.0f</span>, -rcpSqrt2),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, rcpSqrt2, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt2, -rcpSqrt2, <span class="number">0.0f</span>),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt3, rcpSqrt3, rcpSqrt3),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt3, -rcpSqrt3, rcpSqrt3),</span><br><span class="line">    <span class="keyword">new</span> Vector3(rcpSqrt3, rcpSqrt3, rcpSqrt3),</span><br><span class="line">    <span class="keyword">new</span> Vector3(-rcpSqrt3, -rcpSqrt3, rcpSqrt3),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>2.核心功能</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Their either was no existing mesh or the user wanted to overwrite it,</span></span><br><span class="line"><span class="comment">// generate a new K-DOP</span></span><br><span class="line"></span><br><span class="line">List&lt;KDOPPolygon&gt; polys = KDOPPolygon.GenerateKDopPolygons(gameObject.transform, meshFilters, dirs);</span><br><span class="line">Mesh kdopMesh = KDOPPolygon.MeshFromPolygons(polys);</span><br></pre></td></tr></table></figure>

<p><font color=#ffa500>KDOPPolygon.GenerateTangentSpace</font></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Helper function to generate arbitrary tangent / bitangent for a given normal</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateTangentSpace</span>(<span class="params">Vector3 normal, <span class="keyword">out</span> Vector3 tangent, <span class="keyword">out</span> Vector3 bitangent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Vector3 N = <span class="keyword">new</span> Vector3(Mathf.Abs(normal.x), Mathf.Abs(normal.y), Mathf.Abs(normal.z));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find best basis vectors.</span></span><br><span class="line">    <span class="keyword">if</span> (N.z &gt; N.x &amp;&amp; N.z &gt; N.y)</span><br><span class="line">    &#123;</span><br><span class="line">        tangent = <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        tangent = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 得到和法线想垂直的向量作为切线，normal取自预先设定好的数组，不需要进行 normalize()</span></span><br><span class="line">    tangent = Vector3.Normalize(tangent - normal * Vector3.Dot(tangent, normal));</span><br><span class="line">    bitangent = Vector3.Cross(tangent, normal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=#ffa500>KDOPPolygon.Split</font></p>
<p>方法中的参数planeOrigin表示平面的原点（一个点），planeNormal表示平面的法线方向（一个单位向量）。</p>
<p>首先，使用一个循环遍历多边形的所有边（由顶点Vertices[i]和Vertices[j]组成），并检查它们是否与平面相交。对于每条边，通过计算边向量t与平面法线的点积t_dot_n，来判断是否可能存在交点。如果点积的绝对值大于一个较小的阈值（1e-4f），表示存在可能的交点。</p>
<p>如果存在可能的交点，再计算交点参数d，通过计算平面原点到顶点Vertices[i]的向量与平面法线的点积，除以边向量t与平面法线的点积。如果d的值在0和1之间，表示交点在边上（不包括顶点），则在这个位置将交点插入到多边形的顶点列表中。</p>
<p>接下来，将平面原点沿着平面法线方向稍微向外偏移（planeOrigin -&#x3D; planeNormal * 0.001f）。</p>
<p>最后，再次遍历多边形的顶点列表，将位于平面负（错误）一侧的顶点从列表中移除，即将多边形中位于平面错误一侧的部分去除。</p>
<p>这样，通过在给定平面上进行分割操作，可以将多边形切割为两个或更多部分，其中一部分位于平面的正（正确）一侧，另一部分位于平面的负（错误）一侧。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算平面和线的交点</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">CalculatePlaneLineIntersection</span>(<span class="params">Vector3 planeNormal, Vector3 planePoint, Vector3 linePoint, Vector3 lineDirection</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> dot = Vector3.Dot(planeNormal, lineDirection);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果线与平面平行，则没有交点</span></span><br><span class="line">    <span class="keyword">if</span> (Mathf.Approximately(dot, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Vector3.zero;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">float</span> t = Vector3.Dot(planeNormal, planePoint - linePoint) / dot;</span><br><span class="line">    Vector3 intersectionPoint = linePoint + t * lineDirection;</span><br><span class="line">    <span class="keyword">return</span> intersectionPoint;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Split this polygon at a plane. </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Split</span>(<span class="params">Vector3 planeOrigin, Vector3 planeNormal</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Loop over all edges i..j and check whether they intersect the plane</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Vertices.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> j = (i + <span class="number">1</span>) % Vertices.Count;</span><br><span class="line"></span><br><span class="line">        Vector3 t = Vertices[j] - Vertices[i];</span><br><span class="line">        <span class="built_in">float</span> t_dot_n = Vector3.Dot(t, planeNormal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Dot product != 0? Possible intersection </span></span><br><span class="line">        <span class="keyword">if</span> (Mathf.Abs(t_dot_n) &gt; <span class="number">1e-4</span>f)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//计算平面和线的交点</span></span><br><span class="line">            <span class="comment">//平面公式 Ax+By+Cz+D=0 (A\B\C)是法线向量的分量，D是-N·P(点)</span></span><br><span class="line">            <span class="comment">//线的公式 P=P0+tD</span></span><br><span class="line">            <span class="comment">//如果存在 t 值，说明有交点，0-1范围说明交点在线段上</span></span><br><span class="line">            <span class="built_in">float</span> d = Vector3.Dot(planeOrigin - Vertices[i], planeNormal) / t_dot_n;</span><br><span class="line">            <span class="keyword">if</span> (d &gt; <span class="number">0.0f</span> &amp;&amp; d &lt; <span class="number">1.0f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Vertices.Insert(i + <span class="number">1</span>, d * t + Vertices[i]);</span><br><span class="line">                ++i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Shift plane origin for clipping</span></span><br><span class="line">    planeOrigin -= planeNormal * <span class="number">0.001f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove all vertices that are on the wrong side of the cutting plane</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Vertices.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Vector3.Dot(Vertices[i] - planeOrigin, planeNormal) &lt; <span class="number">0.0f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Vertices.RemoveAt(i);</span><br><span class="line">            --i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><font color=#ffa500>KDOPPolygon.GenerateKDopPolygons</font></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate the polygons for a K-DOP by iteratively intersecting planes with each other.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;KDOPPolygon&gt; <span class="title">GenerateKDopPolygons</span>(<span class="params">Transform rootTransform, MeshFilter[] meshFilters, Vector3[] dirs</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> planePairCount = dirs.Length;</span><br><span class="line">    <span class="built_in">float</span>[] minDist = <span class="keyword">new</span> <span class="built_in">float</span>[planePairCount];</span><br><span class="line">    <span class="built_in">float</span>[] maxDist = <span class="keyword">new</span> <span class="built_in">float</span>[planePairCount];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; planePairCount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        minDist[i] = <span class="built_in">float</span>.MaxValue;</span><br><span class="line">        maxDist[i] = -<span class="built_in">float</span>.MaxValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extents of the initial planes</span></span><br><span class="line">    <span class="built_in">float</span> PlaneExtents = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop over all meshes</span></span><br><span class="line">    <span class="keyword">foreach</span> (MeshFilter meshFilter <span class="keyword">in</span> meshFilters)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Choose a value well over the extents of the mesh for initial planes</span></span><br><span class="line">        Mesh mesh = meshFilter.sharedMesh;</span><br><span class="line">        Vector3[] vertices = mesh.vertices;</span><br><span class="line">        PlaneExtents = Mathf.Max(PlaneExtents, <span class="number">100.0f</span> * Mathf.Max(mesh.bounds.extents.x, Mathf.Max(mesh.bounds.extents.y, mesh.bounds.extents.z)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For each vertex, project along each K-DOP direction, to find max and min in that direction</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mesh.vertexCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// We may be dealing with complex GameObjects here, so the root object may have a transform (which</span></span><br><span class="line">            <span class="comment">// will also be applied to the collision mesh and thus is to be ignored), and the children may have</span></span><br><span class="line">            <span class="comment">// a transform too (which is important to end up with a correct collision mesh for the compound</span></span><br><span class="line">            <span class="comment">// object). Let&#x27;s deal with that.</span></span><br><span class="line">            Vector3 vertex = vertices[i];</span><br><span class="line">            vertex = meshFilter.transform.TransformPoint(vertex);</span><br><span class="line">            vertex = rootTransform.InverseTransformPoint(vertex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; planePairCount; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">float</span> dist = Vector3.Dot(vertex, dirs[j]);</span><br><span class="line">                minDist[j] = Mathf.Min(dist, minDist[j]);</span><br><span class="line">                maxDist[j] = Mathf.Max(dist, maxDist[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate and split polygons</span></span><br><span class="line">    List&lt;KDOPPolygon&gt; polys = <span class="keyword">new</span> List&lt;KDOPPolygon&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; planePairCount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Get tangent / bitangent</span></span><br><span class="line">        Vector3 AxisX, AxisY;</span><br><span class="line">        GenerateTangentSpace(dirs[i], <span class="keyword">out</span> AxisX, <span class="keyword">out</span> AxisY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// which 0: Positive (maximum) plane</span></span><br><span class="line">        <span class="comment">// which 1: Negative (minimum) plane</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> which = <span class="number">0</span>; which &lt; <span class="number">2</span>; ++which)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Create first polygon</span></span><br><span class="line">            KDOPPolygon poly = <span class="keyword">new</span> KDOPPolygon();</span><br><span class="line">            poly.Normal = (which == <span class="number">0</span> ? dirs[i] : -dirs[i]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Vector3.Dot(Vector3.Cross(AxisX, AxisY), poly.Normal) &gt; <span class="number">0.0f</span>)</span><br><span class="line">                AxisX *= <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            Vector3 baseP = dirs[i] * (which == <span class="number">0</span> ? maxDist[i] : minDist[i]);</span><br><span class="line">            poly.Vertices.Add(baseP + AxisX * PlaneExtents + AxisY * PlaneExtents);</span><br><span class="line">            poly.Vertices.Add(baseP + AxisX * PlaneExtents - AxisY * PlaneExtents);</span><br><span class="line">            poly.Vertices.Add(baseP - AxisX * PlaneExtents - AxisY * PlaneExtents);</span><br><span class="line">            poly.Vertices.Add(baseP - AxisX * PlaneExtents + AxisY * PlaneExtents);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; planePairCount; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (i != j || which == <span class="number">1</span>) poly.Split(dirs[j] * maxDist[j], -dirs[j]);</span><br><span class="line">                <span class="keyword">if</span> (i != j || which == <span class="number">0</span>) poly.Split(dirs[j] * minDist[j], dirs[j]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (poly.Vertices.Count &gt;= <span class="number">3</span>)</span><br><span class="line">                polys.Add(poly);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> polys;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><font color=#ffa500>KDOPPolygon.MeshFromPolygons</font><br>Mesh顶点数据生成</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Generate a mesh from a list </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Mesh <span class="title">MeshFromPolygons</span>(<span class="params">List&lt;KDOPPolygon&gt; polys</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Generate mesh</span></span><br><span class="line">    List&lt;Vector3&gt; vertices = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line">    List&lt;<span class="built_in">int</span>&gt; indices = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (KDOPPolygon p <span class="keyword">in</span> polys)</span><br><span class="line">        p.ToTriangles(vertices, indices);</span><br><span class="line"></span><br><span class="line">    Mesh mesh = <span class="keyword">new</span> Mesh();</span><br><span class="line">    mesh.vertices = vertices.ToArray();</span><br><span class="line">    mesh.SetIndices(indices.ToArray(), MeshTopology.Triangles, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<h4 id="缓存敏感和缓存相关表示"><a href="#缓存敏感和缓存相关表示" class="headerlink" title="缓存敏感和缓存相关表示"></a>缓存敏感和缓存相关表示</h4><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/403554758">19.1 空间数据结构 - Justin的文章 - 知乎</a></p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2023/01/08/Unity/Live2d/"
      title="Live2d"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        Live2d
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2022/12/17/Engine/Engine/"
      title="Engine"
     >

    <p class="title-text">
      
        Engine
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>






    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 泥头车<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
